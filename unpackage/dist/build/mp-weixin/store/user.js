"use strict";const e=require("../common/vendor.js"),a=e.defineStore("User",(()=>{const a=e.ref();new e.dayjs;const t=e.ref(null),o=t=>{e.index.login({provider:"weixin",success:o=>{e.$s.callFunction({name:"wxLogin",data:{code:o.code,token:t},success:e=>{console.log(e),a.value=e.result.Userdata.doc}})},fail:e=>{}})},s=t=>{console.log("注册"),e.index.login({provider:"weixin",success:o=>{e.$s.callFunction({name:"wxRegistered",data:{code:o.code,UserData:t},success:t=>{const{ok:o,token:s,msg:l}=t.result;200===o&&(console.log("1",t.result.Userdata.data[0]),a.value=t.result.Userdata.data[0],e.index.setStorage({data:s,key:"token"}))}})}})},l=async()=>{const{collect:t}=a.value,o=await e.$s.database();await o.collection("users").doc(a.value._id).update({collect:t})},c=async()=>{try{return(await e.index.getStorage({key:"token"})).data}catch(a){return!1}};return{UserData:a,GetUser:async()=>{t.value=await c(),t.value?await o(t.value):await s({user_name:"未知名",collect:[],integral:1,theme:{dark:!0,color:0,size:"16px"},RegisteredTime:(new Date).getTime(),PoemNumber:0,avatar:"",region:"中国",self_introduction:"自东向西",slogan:"你好,世界!"})},SetAvatarUrl:async t=>{const o=await e.$s.uploadFile({filePath:t,cloudPath:"a.jpg",onUploadProgress:function(e){var a=Math.round(100*e.loaded/e.total);console.log(a)}});a.value.avatar=o.fileID},SetUser:async()=>{const{avatar:t,user_name:o,slogan:s,self_introduction:l}=a.value,c=await e.$s.database();await c.collection("users").doc(a.value._id).update({avatar:t,user_name:o,slogan:s,self_introduction:l})},SetText:(e,t)=>{a.value[`${e}`]=t},SetCollect:e=>{a.value.collect.push(e);try{l()}catch(t){console.log(t,"添加失败")}},removeCollect:e=>{a.value.collect.splice(e,1);try{return l(),{msg:"删除成功"}}catch(t){return{msg:"删除失败"}}},SetPoemNumber:async t=>{const{PoemNumber:o}=a.value;let s=o+1;const l=await e.$s.database();await l.collection("users").doc(a.value._id).update({PoemNumber:s})}}}));exports.useUserstore=a;
