"use strict";const e=require("../common/vendor.js"),a=e.defineStore("User",(()=>{const a=e.ref(),t=e.ref(null),s=t=>{e.index.login({provider:"weixin",success:s=>{e.$s.callFunction({name:"wxLogin",data:{code:s.code,token:t},success:e=>{a.value=e.result.Userdata.data[0]}})},fail:e=>{}})},o=t=>{console.log("注册"),e.index.login({provider:"weixin",success:s=>{e.$s.callFunction({name:"wxRegistered",data:{code:s.code,UserData:t},success:t=>{const{ok:s,token:o,msg:l}=t.result;200===s&&(console.log("1",t.result.Userdata.data[0]),a.value=t.result.Userdata.data[0],e.index.setStorage({data:o,key:"token"}))}})}})},l=async()=>{const{collect:t}=a.value,s=await e.$s.database();await s.collection("users").doc(a.value._id).update({collect:t})},c=async()=>{try{return(await e.index.getStorage({key:"token"})).data}catch(a){return!1}};return{UserData:a,GetUser:async()=>{t.value=await c(),t.value?await s(t.value):await o({user_name:"未知名",collect:[],integral:1,create:[],theme:{dark:!0,color:0,size:"16px"},PoemNumber:1,avatar:"",region:"中国",self_introduction:"自东向西",slogan:"你好,世界!"})},SetAvatarUrl:async t=>{const s=await e.$s.uploadFile({filePath:t,cloudPath:"a.jpg",onUploadProgress:function(e){var a=Math.round(100*e.loaded/e.total);console.log(a)}});a.value.avatar=s.fileID},SetUser:async()=>{const{avatar:t,user_name:s,slogan:o,self_introduction:l}=a.value,c=await e.$s.database();await c.collection("users").doc(a.value._id).update({avatar:t,user_name:s,slogan:o,self_introduction:l})},SetText:(e,t)=>{a.value[`${e}`]=t},SetCollect:e=>{a.value.collect.push(e);try{l()}catch(t){console.log(t,"添加失败")}},removeCollect:e=>{a.value.collect.splice(e,1);try{return l(),{msg:"删除成功"}}catch(t){return{msg:"删除失败"}}},setcreate:async t=>{const{create:s}=a.value;s.push({...t,_id:s.lenght});const o=await e.$s.database();await o.collection("users").doc(a.value._id).update({create:s})}}}));exports.useUserstore=a;
